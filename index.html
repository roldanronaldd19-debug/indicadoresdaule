<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Análisis de Desechos Sólidos - Cantón Daule</title>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js con plugins avanzados -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --primary-dark: #0d5d57;
      --secondary: #2d4cc8;
      --accent: #7c3aed;
      --bg1: #f8fafc;
      --bg2: #f0fdfa;
      --card: #ffffff;
      --muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --radius: 12px;
      --radius-sm: 8px;
      --header-height: 80px;
      --sidebar-width: 280px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: #1e293b;
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Header mejorado */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 0 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--header-height);
      gap: 20px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
    }
    
    .logo-icon {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: transform 0.3s ease;
    }
    
    .logo:hover .logo-icon {
      transform: rotate(15deg);
    }
    
    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
    }
    
    .subtitle {
      opacity: 0.9;
      font-size: 14px;
      font-weight: 400;
    }
    
    .header-stats {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      flex: 1;
    }
    
    .header-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      min-width: 120px;
      transition: all 0.2s ease;
    }
    
    .header-stat:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }
    
    .header-stat-value {
      font-size: 18px;
      font-weight: 700;
      color: white;
    }
    
    .header-stat-label {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 2px;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
    }
    
    /* Main layout mejorado */
    main {
      max-width: 1400px;
      margin: 32px auto;
      padding: 0 20px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--primary), var(--primary-light));
      border-radius: var(--radius) 0 0 var(--radius);
    }
    
    .card-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .card-title i {
      color: var(--primary-light);
    }
    
    .card-subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-top: -15px;
      margin-bottom: 20px;
      font-weight: 400;
    }
    
    /* Controles mejorados */
    .controls-section {
      grid-column: span 12;
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-group label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-group label i {
      color: var(--primary);
      width: 20px;
    }
    
    .filter-info {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    select {
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: white;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%230f766e'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px;
      appearance: none;
      padding-right: 50px;
      cursor: pointer;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }
    
    .control-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    /* Botones mejorados */
    button {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(15, 118, 110, 0.2);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    button.secondary:hover {
      background: var(--bg1);
      border-color: var(--primary-light);
    }
    
    button.danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    button.danger:hover {
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.2);
    }
    
    /* Summary cards mejoradas */
    .summary-section {
      grid-column: span 12;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #ffffff, #f7fffb);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid #eef7f4;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    .summary-card::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, rgba(15, 118, 110, 0.05), transparent);
      border-radius: 0 0 0 100%;
    }
    
    .summary-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-light);
    }
    
    .summary-card-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: white;
      font-size: 20px;
    }
    
    .summary-card-content {
      flex: 1;
    }
    
    .summary-title {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .summary-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
      line-height: 1.2;
    }
    
    .summary-subtitle {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .summary-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-top: 8px;
    }
    
    .summary-change.positive {
      color: var(--success);
    }
    
    .summary-change.negative {
      color: var(--danger);
    }
    
    /* Chart section mejorada */
    .chart-section {
      grid-column: span 8;
    }
    
    .chart-container {
      position: relative;
      height: 500px;
      margin-top: 20px;
      background: white;
      border-radius: var(--radius-sm);
      padding: 16px;
      border: 1px solid var(--border);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }
    
    /* Stats sidebar */
    .stats-sidebar {
      grid-column: span 4;
    }
    
    .stats-card {
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    .stats-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stats-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: white;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    
    .stat-item:hover {
      border-color: var(--primary-light);
      transform: translateX(4px);
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }
    
    /* Table section */
    .table-section {
      grid-column: span 12;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: white;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 800px;
    }
    
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: var(--muted);
      font-size: 14px;
      border-bottom: 2px solid var(--border);
      position: relative;
    }
    
    th::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--primary);
      transition: width 0.3s ease;
    }
    
    th:hover::after {
      width: 100%;
    }
    
    td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.2s ease;
    }
    
    tr:hover td {
      background-color: #f8fafc;
    }
    
    .category-header td {
      background-color: #f0f9ff;
      font-weight: 600;
      color: var(--primary);
      border-top: 2px solid var(--border);
    }
    
    .subcategory-row td:first-child {
      padding-left: 40px;
      position: relative;
    }
    
    .subcategory-row td:first-child::before {
      content: '↳';
      position: absolute;
      left: 20px;
      color: var(--muted);
    }
    
    .total-row {
      background-color: #f0f9ff;
      font-weight: 700;
    }
    
    .total-row td {
      border-top: 2px solid var(--primary);
    }
    
    /* Footer mejorado */
    footer {
      margin: 48px 0 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }
    
    .footer-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 32px;
      margin-bottom: 32px;
    }
    
    .footer-section h4 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
    }
    
    .footer-section p {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }
    
    .footer-links {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .footer-links a {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .footer-links a:hover {
      color: var(--primary);
    }
    
    .footer-bottom {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }
    
    /* Responsive design mejorado */
    @media (max-width: 1200px) {
      .chart-section {
        grid-column: span 12;
      }
      
      .stats-sidebar {
        grid-column: span 12;
      }
      
      .stats-card {
        margin-bottom: 0;
      }
    }
    
    @media (max-width: 992px) {
      .header-content {
        flex-direction: column;
        height: auto;
        padding: 20px 0;
        gap: 20px;
      }
      
      .header-stats {
        order: 3;
        width: 100%;
      }
      
      .header-stat {
        min-width: 100px;
      }
    }
    
    @media (max-width: 768px) {
      .dashboard-grid {
        gap: 16px;
      }
      
      .card {
        padding: 20px;
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .summary-value {
        font-size: 28px;
      }
      
      .chart-container {
        height: 400px;
      }
      
      .control-actions {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }
    
    @media (max-width: 576px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
      
      .header-stats {
        flex-direction: column;
        align-items: stretch;
      }
      
      .header-stat {
        width: 100%;
      }
    }
    
    /* Utilidades */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      flex-direction: column;
      gap: 16px;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(15, 118, 110, 0.1);
      border-left: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: var(--primary-light);
      color: white;
    }
    
    .badge.success {
      background: var(--success);
    }
    
    .badge.warning {
      background: var(--warning);
    }
    
    .badge.danger {
      background: var(--danger);
    }
    
    .divider {
      height: 1px;
      background: var(--border);
      margin: 24px 0;
      border: none;
    }
    
    /* Animaciones */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* Scrollbar personalizado */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-recycle"></i>
        </div>
        <div class="logo-text">
          <h1>Análisis de Desechos Sólidos</h1>
          <div class="subtitle">Cantón Daule - Panel de Indicadores Ambientales</div>
        </div>
      </div>
      
      <div class="header-stats">
        <div class="header-stat">
          <div class="header-stat-value" id="headerTotalEncuestas">0</div>
          <div class="header-stat-label">Total Encuestas</div>
        </div>
        <div class="header-stat">
          <div class="header-stat-value" id="headerTotalKg">0 kg</div>
          <div class="header-stat-label">Desechos Totales</div>
        </div>
        <div class="header-stat">
          <div class="header-stat-value" id="headerPromedio">0 kg</div>
          <div class="header-stat-label">Promedio por Encuesta</div>
        </div>
        <div class="header-stat">
          <div class="header-stat-value" id="headerUbicaciones">0</div>
          <div class="header-stat-label">Ubicaciones</div>
        </div>
      </div>
      
      <div class="header-actions">
        <button id="btnExport" class="secondary" title="Exportar datos">
          <i class="fas fa-file-export"></i>
          <span class="action-text">Exportar</span>
        </button>
        <button id="btnHelp" class="secondary" title="Ayuda">
          <i class="fas fa-question-circle"></i>
          <span class="action-text">Ayuda</span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <!-- Panel de control principal con grid -->
    <div class="dashboard-grid">
      
      <!-- Sección de controles -->
      <div class="card controls-section fade-in">
        <div class="card-title">
          <div>
            <i class="fas fa-sliders-h"></i>
            Filtros de Análisis
          </div>
          <span class="badge" id="filterBadge">Filtros activos: 0</span>
        </div>
        <p class="card-subtitle">Seleccione los criterios para filtrar los datos de desechos sólidos</p>
        
        <div class="controls-grid">
          <div class="control-group">
            <label for="selectLugar">
              <i class="fas fa-map-marker-alt"></i>
              Ubicación Geográfica
            </label>
            <select id="selectLugar">
              <option value="">Todas las ubicaciones</option>
            </select>
            <div class="filter-info">
              <i class="fas fa-info-circle"></i>
              <span id="lugarInfo">Cargando ubicaciones...</span>
            </div>
          </div>
          
          <div class="control-group">
            <label for="selectFecha">
              <i class="fas fa-calendar-alt"></i>
              Rango de Fecha
            </label>
            <select id="selectFecha">
              <option value="">Todo el período</option>
              <option value="2024">Año 2024</option>
              <option value="2025">Año 2025</option>
            </select>
            <div class="filter-info">
              <i class="fas fa-clock"></i>
              <span>Período completo disponible</span>
            </div>
          </div>
          
          <div class="control-group">
            <label for="selectTipo">
              <i class="fas fa-filter"></i>
              Tipo de Análisis
            </label>
            <select id="selectTipo">
              <option value="total">Total por categoría</option>
              <option value="promedio">Promedio por encuesta</option>
              <option value="porcentaje">Distribución porcentual</option>
            </select>
            <div class="filter-info">
              <i class="fas fa-chart-pie"></i>
              <span>Visualización de datos agregados</span>
            </div>
          </div>
        </div>
        
        <div class="control-actions">
          <button id="btnApplyFilters">
            <i class="fas fa-check"></i>
            Aplicar Filtros
          </button>
          <button id="btnResetFilters" class="secondary">
            <i class="fas fa-undo"></i>
            Restablecer Todo
          </button>
          <button id="btnAdvanced" class="secondary">
            <i class="fas fa-cog"></i>
            Opciones Avanzadas
          </button>
        </div>
      </div>
      
      <!-- Sección de resumen -->
      <div class="card summary-section fade-in" style="animation-delay: 0.1s">
        <div class="card-title">
          <div>
            <i class="fas fa-chart-line"></i>
            Resumen General
          </div>
          <span class="badge success" id="summaryBadge">Datos actualizados</span>
        </div>
        <p class="card-subtitle">Métricas clave del análisis de desechos sólidos</p>
        
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-card-icon">
              <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="summary-card-content">
              <div class="summary-title">Total de Encuestas</div>
              <div class="summary-value" id="summaryEncuestas">0</div>
              <div class="summary-subtitle">
                <i class="fas fa-database"></i>
                <span>Registros en la base de datos</span>
              </div>
              <div class="summary-change positive">
                <i class="fas fa-arrow-up"></i>
                <span id="changeEncuestas">+0% vs total</span>
              </div>
            </div>
          </div>
          
          <div class="summary-card">
            <div class="summary-card-icon">
              <i class="fas fa-map-marked-alt"></i>
            </div>
            <div class="summary-card-content">
              <div class="summary-title">Ubicaciones Únicas</div>
              <div class="summary-value" id="summaryUbicaciones">0</div>
              <div class="summary-subtitle">
                <i class="fas fa-location-dot"></i>
                <span>Lugares distintos registrados</span>
              </div>
              <div class="summary-change positive">
                <i class="fas fa-arrow-up"></i>
                <span id="changeUbicaciones">+0% vs total</span>
              </div>
            </div>
          </div>
          
          <div class="summary-card">
            <div class="summary-card-icon">
              <i class="fas fa-weight-hanging"></i>
            </div>
            <div class="summary-card-content">
              <div class="summary-title">Total de Desechos</div>
              <div class="summary-value" id="summaryTotalKg">0 kg</div>
              <div class="summary-subtitle">
                <i class="fas fa-scale-balanced"></i>
                <span>Suma total de kilogramos</span>
              </div>
              <div class="summary-change positive">
                <i class="fas fa-arrow-up"></i>
                <span id="changeTotalKg">+0% vs total</span>
              </div>
            </div>
          </div>
          
          <div class="summary-card">
            <div class="summary-card-icon">
              <i class="fas fa-balance-scale"></i>
            </div>
            <div class="summary-card-content">
              <div class="summary-title">Promedio por Encuesta</div>
              <div class="summary-value" id="summaryPromedio">0 kg</div>
              <div class="summary-subtitle">
                <i class="fas fa-chart-bar"></i>
                <span>Kilogramos promedio por registro</span>
              </div>
              <div class="summary-change positive">
                <i class="fas fa-arrow-up"></i>
                <span id="changePromedio">+0% vs total</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sección de gráficos -->
      <div class="card chart-section fade-in" style="animation-delay: 0.2s">
        <div class="card-title">
          <div>
            <i class="fas fa-chart-bar"></i>
            Visualización de Datos
          </div>
          <div class="chart-actions">
            <button class="chart-action-btn active" data-chart-type="bar">
              <i class="fas fa-chart-bar"></i> Barras
            </button>
            <button class="chart-action-btn" data-chart-type="pie">
              <i class="fas fa-chart-pie"></i> Torta
            </button>
            <button class="chart-action-btn" data-chart-type="line">
              <i class="fas fa-chart-line"></i> Líneas
            </button>
          </div>
        </div>
        
        <div class="chart-header">
          <div class="chart-title" id="chartTitle">
            Distribución de Desechos por Categoría Principal
          </div>
          <div class="chart-legend" id="chartLegend"></div>
        </div>
        
        <div class="chart-container">
          <canvas id="mainChart"></canvas>
        </div>
        
        <div class="chart-footer">
          <div class="filter-info">
            <i class="fas fa-info-circle"></i>
            <span id="chartInfo">Mostrando todas las categorías con datos disponibles</span>
          </div>
        </div>
      </div>
      
      <!-- Barra lateral de estadísticas -->
      <div class="card stats-sidebar fade-in" style="animation-delay: 0.3s">
        <div class="card-title">
          <i class="fas fa-chart-simple"></i>
          Estadísticas Rápidas
        </div>
        
        <div class="stats-card">
          <div class="stats-title">
            <i class="fas fa-ranking-star"></i>
            Top Categorías
          </div>
          <div class="stats-list" id="topCategories"></div>
        </div>
        
        <div class="stats-card">
          <div class="stats-title">
            <i class="fas fa-lightbulb"></i>
            Insights
          </div>
          <div class="stats-list">
            <div class="stat-item">
              <div class="stat-label">
                <i class="fas fa-leaf"></i>
                <span>Materia Orgánica</span>
              </div>
              <div class="stat-value" id="insightOrganico">0%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">
                <i class="fas fa-recycle"></i>
                <span>Reciclables</span>
              </div>
              <div class="stat-value" id="insightReciclable">0%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">
                <i class="fas fa-trash"></i>
                <span>No Reciclables</span>
              </div>
              <div class="stat-value" id="insightNoReciclable">0%</div>
            </div>
          </div>
        </div>
        
        <div class="stats-card">
          <div class="stats-title">
            <i class="fas fa-bolt"></i>
            Rendimiento
          </div>
          <div class="stats-list">
            <div class="stat-item">
              <div class="stat-label">
                <i class="fas fa-chart-line"></i>
                <span>Completitud de Datos</span>
              </div>
              <div class="stat-value" id="performanceData">0%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">
                <i class="fas fa-clock"></i>
                <span>Última Actualización</span>
              </div>
              <div class="stat-value" id="performanceUpdate">Hoy</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sección de tabla -->
      <div class="card table-section fade-in" style="animation-delay: 0.4s">
        <div class="card-title">
          <div>
            <i class="fas fa-table"></i>
            Tabla Resumen Detallada
          </div>
          <div class="table-actions">
            <button id="btnExportTable" class="secondary">
              <i class="fas fa-file-excel"></i>
              Exportar Tabla
            </button>
            <button id="btnToggleDetails" class="secondary">
              <i class="fas fa-eye"></i>
              Ver Detalles
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table id="tableResumen">
            <thead>
              <tr>
                <th>Categoría / Subcategoría</th>
                <th style="text-align:right">Peso (kg)</th>
                <th style="text-align:right">% del Total</th>
                <th style="text-align:center">Tendencia</th>
                <th style="text-align:center">Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div class="table-footer">
          <div class="filter-info">
            <i class="fas fa-info-circle"></i>
            <span id="tableInfo">Mostrando todas las categorías. Haga clic en una fila para ver detalles.</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer mejorado -->
    <footer>
      <div class="footer-content">
        <div class="footer-section">
          <h4>Sobre este Proyecto</h4>
          <p>Panel de análisis de desechos sólidos del Cantón Daule, desarrollado para la gestión ambiental y toma de decisiones basada en datos.</p>
        </div>
        
        <div class="footer-section">
          <h4>Recursos</h4>
          <ul class="footer-links">
            <li><a href="#"><i class="fas fa-book"></i> Documentación</a></li>
            <li><a href="#"><i class="fas fa-database"></i> Base de Datos</a></li>
            <li><a href="#"><i class="fas fa-chart-bar"></i> Reportes Anteriores</a></li>
            <li><a href="#"><i class="fas fa-download"></i> Descargas</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h4>Contacto</h4>
          <p>Para consultas técnicas o soporte:</p>
          <ul class="footer-links">
            <li><a href="mailto:soporte@daule-ec.gob.ec"><i class="fas fa-envelope"></i> soporte@daule-ec.gob.ec</a></li>
            <li><a href="#"><i class="fas fa-phone"></i> +593 4 123 4567</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>© 2024 - Sistema de Análisis de Desechos Sólidos - Cantón Daule, Ecuador</p>
        <p>Fuente: Base de datos <code>caracterizacion_desechos_daule</code> | Última actualización: <span id="lastUpdate">25 de noviembre de 2024</span></p>
      </div>
    </footer>
  </main>

  <script>
  (async function(){
    // ---------- CONFIGURACIÓN ----------
    const SUPABASE_URL = "https://dutapywxsiuxboqsjqvf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ---------- SELECTORES ----------
    const selectLugar = document.getElementById('selectLugar');
    const selectFecha = document.getElementById('selectFecha');
    const selectTipo = document.getElementById('selectTipo');
    const btnApplyFilters = document.getElementById('btnApplyFilters');
    const btnResetFilters = document.getElementById('btnResetFilters');
    const btnAdvanced = document.getElementById('btnAdvanced');
    const btnExport = document.getElementById('btnExport');
    const btnExportTable = document.getElementById('btnExportTable');
    const btnToggleDetails = document.getElementById('btnToggleDetails');
    const btnHelp = document.getElementById('btnHelp');

    // Elementos de información
    const lugarInfo = document.getElementById('lugarInfo');
    const filterBadge = document.getElementById('filterBadge');
    const summaryBadge = document.getElementById('summaryBadge');
    const chartTitle = document.getElementById('chartTitle');
    const chartInfo = document.getElementById('chartInfo');
    const tableInfo = document.getElementById('tableInfo');

    // Elementos de resumen
    const summaryEncuestas = document.getElementById('summaryEncuestas');
    const summaryUbicaciones = document.getElementById('summaryUbicaciones');
    const summaryTotalKg = document.getElementById('summaryTotalKg');
    const summaryPromedio = document.getElementById('summaryPromedio');
    const changeEncuestas = document.getElementById('changeEncuestas');
    const changeUbicaciones = document.getElementById('changeUbicaciones');
    const changeTotalKg = document.getElementById('changeTotalKg');
    const changePromedio = document.getElementById('changePromedio');
    
    // Header stats
    const headerTotalEncuestas = document.getElementById('headerTotalEncuestas');
    const headerTotalKg = document.getElementById('headerTotalKg');
    const headerPromedio = document.getElementById('headerPromedio');
    const headerUbicaciones = document.getElementById('headerUbicaciones');
    
    // Stats sidebar
    const topCategories = document.getElementById('topCategories');
    const insightOrganico = document.getElementById('insightOrganico');
    const insightReciclable = document.getElementById('insightReciclable');
    const insightNoReciclable = document.getElementById('insightNoReciclable');
    const performanceData = document.getElementById('performanceData');
    const performanceUpdate = document.getElementById('performanceUpdate');
    
    // Last update
    const lastUpdate = document.getElementById('lastUpdate');
    
    // Tabla
    const tbody = document.querySelector('#tableResumen tbody');

    // Charts
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    let mainChart;

    // Variables globales para datos
    let currentData = [];
    let allData = [];
    let currentChartType = 'bar';
    let filterOptions = {
      lugares: []
    };
    
    // Variables para estadísticas
    let totalStats = {
      encuestas: 0,
      ubicaciones: 0,
      totalKg: 0,
      promedio: 0
    };

    // Definición de las 15 categorías principales con sus subcategorías
    const categoriasPrincipales = [
      {
        id: 1,
        nombre: "MATERIA ORGANICA",
        tipo: "orgánico",
        subcategorias: [
          { campo: "materia_organica_jardin_kg", nombre: "De jardin" },
          { campo: "materia_organica_cocina_kg", nombre: "De cocina" }
        ]
      },
      {
        id: 2,
        nombre: "GRASAS Y ACEITES",
        tipo: "no reciclable",
        subcategorias: [
          { campo: "grasas_aceite_comestible_kg", nombre: "Aceite comestible" }
        ]
      },
      {
        id: 3,
        nombre: "MEDICINA",
        tipo: "especial",
        subcategorias: [
          { campo: "medicina_jarabe_kg", nombre: "JARABE" },
          { campo: "medicina_tabletas_kg", nombre: "TABLETAS" }
        ]
      },
      {
        id: 4,
        nombre: "PAPELES Y CARTON",
        tipo: "reciclable",
        subcategorias: [
          { campo: "papel_blanco_kg", nombre: "Papel Blanco" },
          { campo: "papel_periodico_kg", nombre: "Papel periodico" },
          { campo: "papel_archivo_kg", nombre: "Papel archivo" },
          { campo: "carton_kg", nombre: "Cartón" },
          { campo: "tetra_brik_kg", nombre: "Tetra-brik" }
        ]
      },
      {
        id: 5,
        nombre: "PLASTICOS",
        tipo: "reciclable",
        subcategorias: [
          { campo: "plastico_pet_kg", nombre: "PET" },
          { campo: "plastico_mixto_kg", nombre: "Plastico mixto" },
          { campo: "bot_aceite_kg", nombre: "Bot de aceite" },
          { campo: "bolsas_kg", nombre: "Bolsas" }
        ]
      },
      {
        id: 6,
        nombre: "VIDRIOS",
        tipo: "reciclable",
        subcategorias: [
          { campo: "vidrio_blanco_kg", nombre: "Blanco" },
          { campo: "vidrio_verde_kg", nombre: "Verde" },
          { campo: "vidrio_otros_kg", nombre: "Otros" }
        ]
      },
      {
        id: 7,
        nombre: "METAL",
        tipo: "reciclable",
        subcategorias: [
          { campo: "latas_ferrosas_kg", nombre: "Latas ferrosas" },
          { campo: "aluminio_kg", nombre: "Aluminio" },
          { campo: "acero_kg", nombre: "Acero" },
          { campo: "metal_otros_kg", nombre: "Otros" }
        ]
      },
      {
        id: 8,
        nombre: "TEXTILES",
        tipo: "reciclable",
        subcategorias: [
          { campo: "textiles_ropa_kg", nombre: "Ropa, mantas, manteles, etc." }
        ]
      },
      {
        id: 9,
        nombre: "CAUCHO",
        tipo: "especial",
        subcategorias: [
          { campo: "caucho_zapatos_neumaticos_kg", nombre: "Zapatos, neumáticos" }
        ]
      },
      {
        id: 10,
        nombre: "CUERO",
        tipo: "especial",
        subcategorias: [
          { campo: "cuero_zapatos_neumaticos_kg", nombre: "Zapatos, carteras, etc." }
        ]
      },
      {
        id: 11,
        nombre: "RESTO SANITARIOS",
        tipo: "no reciclable",
        subcategorias: [
          { campo: "papel_higienico_kg", nombre: "Papel Higienico" }
        ]
      },
      {
        id: 12,
        nombre: "MADERAS",
        tipo: "reciclable",
        subcategorias: [
          { campo: "maderas_kg", nombre: "Maderas" }
        ]
      },
      {
        id: 13,
        nombre: "BATERIAS",
        tipo: "especial",
        subcategorias: [
          { campo: "baterias_tel_lamparas_kg", nombre: "de telefóno, lamparas" }
        ]
      },
      {
        id: 14,
        nombre: "EQUIPOS ELECTRONICOS",
        tipo: "especial",
        subcategorias: [
          { campo: "electronicos_electrodomesticos_kg", nombre: "Electrodomesticos" }
        ]
      },
      {
        id: 15,
        nombre: "ESCOMBROS",
        tipo: "no reciclable",
        subcategorias: [
          { campo: "escombros_otros_kg", nombre: "Otros" }
        ]
      }
    ];

    // Inicializar la aplicación
    async function initApp() {
      await cargarTodosLosDatos();
      await inicializarFiltros();
      await actualizar();
      setupEventListeners();
      updateLastUpdate();
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Botón aplicar filtros
      btnApplyFilters.addEventListener('click', async function() {
        await actualizar();
        updateFilterBadge();
      });
      
      // Botón reset filters
      btnResetFilters.addEventListener('click', function() {
        selectLugar.value = '';
        selectFecha.value = '';
        selectTipo.value = 'total';
        actualizar();
        updateFilterBadge();
      });
      
      // Botón opciones avanzadas
      btnAdvanced.addEventListener('click', () => {
        alert('Funcionalidad de opciones avanzadas próximamente disponible.');
      });
      
      // Botón exportar
      btnExport.addEventListener('click', () => {
        exportarDatos();
      });
      
      // Botón exportar tabla
      btnExportTable.addEventListener('click', () => {
        exportarTabla();
      });
      
      // Botón toggle details
      btnToggleDetails.addEventListener('click', () => {
        toggleTableDetails();
      });
      
      // Botón ayuda
      btnHelp.addEventListener('click', () => {
        mostrarModalAyuda();
      });
      
      // Cambiar tipo de análisis
      selectTipo.addEventListener('change', async function() {
        await actualizar();
      });
      
      // Botones de tipo de gráfico
      document.querySelectorAll('.chart-action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Remover clase activa de todos los botones
          document.querySelectorAll('.chart-action-btn').forEach(b => {
            b.classList.remove('active');
          });
          
          // Agregar clase activa al botón seleccionado
          this.classList.add('active');
          
          // Cambiar tipo de gráfico
          currentChartType = this.getAttribute('data-chart-type');
          
          // Re-renderizar el gráfico
          if (currentData.length > 0) {
            const resumenCategorias = calcularResumenPorCategorias(currentData);
            renderChart(resumenCategorias.categorias, resumenCategorias.valores, currentChartType);
          }
        });
      });
      
      // Actualización automática en tiempo real
      setInterval(() => {
        updatePerformanceTime();
      }, 60000); // Cada minuto
    }

    // Cargar todos los datos para análisis comparativos
    async function cargarTodosLosDatos() {
      const q = await supabase.from('caracterizacion_desechos_daule').select('*');
      if (q.error) {
        console.error(q.error);
        return;
      }
      allData = q.data || [];
      
      // Calcular estadísticas totales
      calcularEstadisticasTotales();
    }

    // Calcular estadísticas totales
    function calcularEstadisticasTotales() {
      totalStats.encuestas = allData.length;
      
      const ubicacionesUnicas = [...new Set(allData.map(r => r.lugar).filter(Boolean))];
      totalStats.ubicaciones = ubicacionesUnicas.length;
      
      const resumenTotal = calcularResumenPorCategorias(allData);
      totalStats.totalKg = resumenTotal.totalSum;
      totalStats.promedio = allData.length > 0 ? resumenTotal.totalSum / allData.length : 0;
    }

    // Cargar lista de filtros desde la BD
    async function inicializarFiltros() {
      // Obtener todos los datos para construir los filtros
      const q = await supabase.from('caracterizacion_desechos_daule').select('lugar');
      if (q.error) {
        console.error(q.error);
        return;
      }
      const rows = q.data || [];

      // Construir opciones de filtro
      filterOptions.lugares = [...new Set(rows.map(r => r.lugar).filter(Boolean))].sort();

      // Actualizar información de filtros
      lugarInfo.textContent = `${filterOptions.lugares.length} ubicaciones disponibles`;

      // Llenar selectores con todas las opciones iniciales
      llenarSelector(selectLugar, filterOptions.lugares);
    }

    // Función para llenar un selector con opciones
    function llenarSelector(selector, opciones) {
      // Guardar la opción seleccionada actualmente
      const valorActual = selector.value;
      
      // Limpiar selector (excepto la primera opción)
      while (selector.options.length > 1) {
        selector.remove(1);
      }
      
      // Agregar nuevas opciones
      opciones.forEach(opcion => {
        const option = document.createElement('option');
        option.value = opcion;
        option.textContent = opcion;
        selector.appendChild(option);
      });
      
      // Restaurar la selección anterior si todavía existe
      if (valorActual && opciones.includes(valorActual)) {
        selector.value = valorActual;
      }
    }

    // Construir query según filtros y traer datos
    async function obtenerFiltrados() {
      let q = supabase.from('caracterizacion_desechos_daule').select('*');
      if (selectLugar.value) q = q.eq('lugar', selectLugar.value);
      
      const r = await q;
      if (r.error) {
        console.error(r.error);
        return [];
      }
      return r.data || [];
    }

    // Calcular resumen por las 15 categorías principales
    function calcularResumenPorCategorias(rows) {
      if (!rows || rows.length === 0) {
        return {
          categorias: [],
          valores: [],
          totalSum: 0,
          detalles: []
        };
      }
      
      const valoresPorCategoria = Array(categoriasPrincipales.length).fill(0);
      const detallesPorCategoria = [];
      
      // Calcular totales por categoría
      rows.forEach(row => {
        categoriasPrincipales.forEach((categoria, idx) => {
          categoria.subcategorias.forEach(subcategoria => {
            const valor = parseFloat(row[subcategoria.campo]) || 0;
            valoresPorCategoria[idx] += valor;
          });
        });
      });
      
      // Preparar detalles para la tabla
      categoriasPrincipales.forEach((categoria, idx) => {
        const totalCategoria = valoresPorCategoria[idx];
        
        // Calcular subtotales por subcategoría
        const subcategoriasConValores = categoria.subcategorias.map(subcategoria => {
          let subtotal = 0;
          rows.forEach(row => {
            subtotal += parseFloat(row[subcategoria.campo]) || 0;
          });
          return {
            nombre: subcategoria.nombre,
            valor: subtotal
          };
        }).filter(sub => sub.valor > 0);
        
        if (totalCategoria > 0 || subcategoriasConValores.length > 0) {
          detallesPorCategoria.push({
            categoria: categoria.nombre,
            tipo: categoria.tipo,
            total: totalCategoria,
            subcategorias: subcategoriasConValores
          });
        }
      });
      
      const totalSum = valoresPorCategoria.reduce((a, b) => a + b, 0);
      
      // Filtrar categorías con valores > 0
      const categoriasConValores = [];
      const valoresFiltrados = [];
      
      detallesPorCategoria.forEach((detalle, idx) => {
        if (detalle.total > 0) {
          categoriasConValores.push(detalle.categoria);
          valoresFiltrados.push(detalle.total);
        }
      });
      
      return {
        categorias: categoriasConValores,
        valores: valoresFiltrados,
        totalSum: totalSum,
        detalles: detallesPorCategoria
      };
    }

    // Renderizar gráfico principal con tipo seleccionado
    function renderChart(labels, values, chartType) {
      if (mainChart) mainChart.destroy();
      
      // Calcular porcentajes para mostrar en los gráficos
      const totalSum = values.reduce((a, b) => a + b, 0);
      const percentages = values.map(v => totalSum > 0 ? ((v / totalSum) * 100).toFixed(1) + '%' : '0%');
      
      // Colores más atractivos y consistentes
      const colors = [
        '#4f46e5', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
        '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#a855f7', '#6366f1',
        '#14b8a6', '#f43f5e', '#8b5cf6'
      ].slice(0, labels.length);
      
      // Configuración base para todos los gráficos
      const baseConfig = {
        data: {
          labels: labels,
          datasets: [{
            label: 'Peso (kg)',
            data: values,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace(')', ', 0.8)')),
            borderWidth: chartType === 'line' ? 3 : 1,
            pointBackgroundColor: colors,
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: chartType === 'line' ? 6 : 0,
            pointHoverRadius: chartType === 'line' ? 8 : 0,
            fill: chartType === 'line' ? {
              target: 'origin',
              above: 'rgba(15, 118, 110, 0.1)'
            } : undefined,
            tension: chartType === 'line' ? 0.4 : 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: chartType === 'pie',
              position: 'right',
              labels: {
                font: {
                  size: 11
                },
                generateLabels: function(chart) {
                  if (chartType === 'pie') {
                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                    const labels = original.call(this, chart);
                    labels.forEach((label, i) => {
                      const value = chart.data.datasets[0].data[i];
                      label.text += ` (${percentages[i]} - ${value.toFixed(1)} kg)`;
                    });
                    return labels;
                  }
                  return Chart.defaults.plugins.legend.labels.generateLabels.call(this, chart);
                }
              }
            },
            title: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) label += ': ';
                  const value = context.parsed !== undefined ? context.parsed : context.raw;
                  label += value.toFixed(2) + ' kg';
                  const percentage = totalSum > 0 ? (value / totalSum * 100).toFixed(1) : 0;
                  label += ` (${percentage}%)`;
                  return label;
                }
              }
            }
          }
        }
      };
      
      // Configuraciones específicas por tipo de gráfico
      const typeSpecificConfigs = {
        bar: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Peso (kg)',
                font: { size: 14, weight: 'bold' }
              },
              ticks: {
                callback: function(value) {
                  return value + ' kg';
                },
                padding: 15
              }
            },
            x: {
              title: {
                display: true,
                text: 'Categorías de Desechos',
                font: { size: 14, weight: 'bold' }
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                padding: 10
              }
            }
          },
          plugins: {
            datalabels: {
              display: true,
              color: '#1e293b',
              font: {
                weight: 'bold',
                size: 11
              },
              formatter: function(value, context) {
                return percentages[context.dataIndex];
              },
              anchor: 'end',
              align: 'top',
              offset: 2
            }
          }
        },
        line: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Peso (kg)',
                font: { size: 14, weight: 'bold' }
              },
              ticks: {
                callback: function(value) {
                  return value + ' kg';
                },
                padding: 15
              }
            },
            x: {
              title: {
                display: true,
                text: 'Categorías de Desechos',
                font: { size: 14, weight: 'bold' }
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                padding: 10
              }
            }
          },
          plugins: {
            datalabels: {
              display: true,
              color: '#1e293b',
              font: {
                weight: 'bold',
                size: 11
              },
              formatter: function(value, context) {
                return percentages[context.dataIndex];
              },
              anchor: 'center',
              align: 'top',
              offset: 10,
              clamp: true
            }
          }
        },
        pie: {
          plugins: {
            datalabels: {
              display: true,
              color: function(context) {
                const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                const rgb = hexToRgb(backgroundColor);
                const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                return brightness > 128 ? '#1e293b' : '#ffffff';
              },
              font: {
                weight: 'bold',
                size: 12
              },
              formatter: function(value, context) {
                const percentage = totalSum > 0 ? ((value / totalSum) * 100) : 0;
                return percentage > 3 ? percentages[context.dataIndex] : '';
              },
              anchor: 'center',
              align: 'center',
              textAlign: 'center',
              textShadow: true,
              shadowBlur: 4,
              shadowColor: 'rgba(0,0,0,0.5)'
            }
          },
          elements: {
            arc: {
              borderWidth: 1.5,
              borderColor: '#ffffff',
              hoverBorderWidth: 2.5,
              hoverBorderColor: '#ffffff'
            }
          }
        }
      };
      
      const finalConfig = {
        type: chartType,
        data: baseConfig.data,
        options: {
          ...baseConfig.options,
          ...(typeSpecificConfigs[chartType] || {}),
          layout: {
            padding: {
              top: chartType === 'line' ? 50 : 20,
              bottom: 30,
              left: 15,
              right: 15
            }
          }
        },
        plugins: chartType === 'pie' || chartType === 'bar' || chartType === 'line' ? [ChartDataLabels] : []
      };
      
      mainChart = new Chart(mainCtx, finalConfig);
      
      // Actualizar título del gráfico según tipo de análisis
      const tipoAnalisis = selectTipo.value;
      const tipoText = {
        'total': 'Total por categoría',
        'promedio': 'Promedio por encuesta',
        'porcentaje': 'Distribución porcentual'
      }[tipoAnalisis] || 'Distribución por Categoría';
      
      chartTitle.textContent = `${tipoText} - ${getChartTypeName(chartType)}`;
    }
    
    // Función auxiliar para convertir HEX a RGB
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : { r: 0, g: 0, b: 0 };
    }
    
    // Obtener nombre legible del tipo de gráfico
    function getChartTypeName(type) {
      const names = {
        'bar': 'Gráfico de Barras',
        'pie': 'Gráfico Circular',
        'line': 'Gráfico de Líneas'
      };
      return names[type] || type;
    }

    // Actualizar badge de filtros
    function updateFilterBadge() {
      let activeFilters = 0;
      if (selectLugar.value) activeFilters++;
      if (selectFecha.value) activeFilters++;
      if (selectTipo.value !== 'total') activeFilters++;
      
      filterBadge.textContent = `Filtros activos: ${activeFilters}`;
      
      // Cambiar color según cantidad de filtros
      if (activeFilters === 0) {
        filterBadge.className = 'badge';
      } else if (activeFilters <= 2) {
        filterBadge.className = 'badge warning';
      } else {
        filterBadge.className = 'badge success';
      }
    }

    // Actualizar estadísticas en el header
    function updateHeaderStats() {
      headerTotalEncuestas.textContent = currentData.length;
      headerUbicaciones.textContent = [...new Set(currentData.map(r => r.lugar).filter(Boolean))].length;
      
      const resumen = calcularResumenPorCategorias(currentData);
      headerTotalKg.textContent = resumen.totalSum.toFixed(0) + ' kg';
      headerPromedio.textContent = (currentData.length > 0 ? resumen.totalSum / currentData.length : 0).toFixed(1) + ' kg';
    }

    // Actualizar estadísticas en sidebar
    function updateSidebarStats(resumen) {
      // Top categorías
      topCategories.innerHTML = '';
      
      const categoriasOrdenadas = [...resumen.detalles]
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);
      
      categoriasOrdenadas.forEach((categoria, index) => {
        const percentage = resumen.totalSum > 0 ? (categoria.total / resumen.totalSum * 100).toFixed(1) : 0;
        
        const statItem = document.createElement('div');
        statItem.className = 'stat-item';
        statItem.innerHTML = `
          <div class="stat-label">
            <span class="badge" style="background: ${getCategoryColor(index)}">${index + 1}</span>
            <span>${categoria.categoria}</span>
          </div>
          <div class="stat-value">${percentage}%</div>
        `;
        topCategories.appendChild(statItem);
      });
      
      // Insights
      const organico = resumen.detalles.find(d => d.categoria === 'MATERIA ORGANICA');
      insightOrganico.textContent = organico ? (organico.total / resumen.totalSum * 100).toFixed(1) + '%' : '0%';
      
      const reciclables = resumen.detalles.filter(d => d.tipo === 'reciclable');
      const totalReciclable = reciclables.reduce((sum, d) => sum + d.total, 0);
      insightReciclable.textContent = resumen.totalSum > 0 ? (totalReciclable / resumen.totalSum * 100).toFixed(1) + '%' : '0%';
      
      const noReciclables = resumen.detalles.filter(d => d.tipo === 'no reciclable');
      const totalNoReciclable = noReciclables.reduce((sum, d) => sum + d.total, 0);
      insightNoReciclable.textContent = resumen.totalSum > 0 ? (totalNoReciclable / resumen.totalSum * 100).toFixed(1) + '%' : '0%';
    }
    
    // Obtener color para categoría
    function getCategoryColor(index) {
      const colors = ['#4f46e5', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444'];
      return colors[index % colors.length];
    }

    // Actualizar rendimiento
    function updatePerformanceTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      performanceUpdate.textContent = timeString;
    }

    // Actualizar última actualización
    function updateLastUpdate() {
      const now = new Date();
      const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      lastUpdate.textContent = now.toLocaleDateString('es-ES', options);
    }

    // Mostrar modal de ayuda
    function mostrarModalAyuda() {
      alert('PANEL DE ANÁLISIS DE DESECHOS SÓLIDOS\n\nEste panel permite analizar datos de desechos sólidos del Cantón Daule.\n\n• Use los filtros para segmentar los datos por ubicación y tipo de análisis\n• Cambie entre tipos de gráficos según su preferencia\n• Consulte las estadísticas rápidas en la barra lateral\n• Exporte los datos para su posterior análisis\n• La tabla muestra el desglose detallado por categorías\n\nLos datos se actualizan automáticamente al aplicar filtros.');
    }

    // Exportar datos
    function exportarDatos() {
      alert('Funcionalidad de exportación de datos próximamente disponible.');
    }

    // Exportar tabla
    function exportarTabla() {
      alert('Funcionalidad de exportación de tabla próximamente disponible.');
    }

    // Toggle detalles de tabla
    function toggleTableDetails() {
      const tableRows = tbody.querySelectorAll('.subcategory-row');
      const isHidden = tableRows[0]?.style.display === 'none';
      
      tableRows.forEach(row => {
        row.style.display = isHidden ? '' : 'none';
      });
      
      btnToggleDetails.innerHTML = isHidden ? 
        '<i class="fas fa-eye"></i> Ocultar Detalles' : 
        '<i class="fas fa-eye"></i> Mostrar Detalles';
      
      tableInfo.textContent = isHidden ? 
        'Mostrando todas las categorías. Haga clic en una fila para ver detalles.' :
        'Mostrando solo categorías principales. Haga clic en una fila para ver detalles.';
    }

    // Rellenar tabla resumen y actualizar resúmenes
    function renderResumen(currentSummary) {
      tbody.innerHTML = '';
      
      // Actualizar resumen de encuestas y ubicaciones
      const encuestas = currentData.length;
      summaryEncuestas.textContent = encuestas;
      
      const ubicacionesUnicas = [...new Set(currentData.map(r => r.lugar).filter(Boolean))];
      summaryUbicaciones.textContent = ubicacionesUnicas.length;
      
      const totalKg = currentSummary.totalSum;
      summaryTotalKg.textContent = totalKg.toFixed(2) + ' kg';
      
      const promedioPorEncuesta = encuestas > 0 ? totalKg / encuestas : 0;
      summaryPromedio.textContent = promedioPorEncuesta.toFixed(2) + ' kg';
      
      // Calcular cambios porcentuales vs total
      const cambioEncuestas = totalStats.encuestas > 0 ? ((encuestas / totalStats.encuestas) * 100 - 100).toFixed(1) : 0;
      const cambioUbicaciones = totalStats.ubicaciones > 0 ? ((ubicacionesUnicas.length / totalStats.ubicaciones) * 100 - 100).toFixed(1) : 0;
      const cambioTotalKg = totalStats.totalKg > 0 ? ((totalKg / totalStats.totalKg) * 100 - 100).toFixed(1) : 0;
      const cambioPromedio = totalStats.promedio > 0 ? ((promedioPorEncuesta / totalStats.promedio) * 100 - 100).toFixed(1) : 0;
      
      // Actualizar cambios
      updateChange(changeEncuestas, cambioEncuestas);
      updateChange(changeUbicaciones, cambioUbicaciones);
      updateChange(changeTotalKg, cambioTotalKg);
      updateChange(changePromedio, cambioPromedio);
      
      // Actualizar performance
      const dataCompleteness = currentData.length > 0 ? 100 : 0;
      performanceData.textContent = dataCompleteness + '%';
      
      // Llenar tabla con categorías y subcategorías
      let totalGeneral = 0;
      let showDetails = true;
      
      currentSummary.detalles.forEach(detalle => {
        if (detalle.total > 0) {
          // Fila de categoría principal
          const porcentajeCategoria = currentSummary.totalSum > 0 ? 
            ((detalle.total / currentSummary.totalSum) * 100).toFixed(2) + '%' : '0.00%';
          
          const trCategoria = document.createElement('tr');
          trCategoria.className = 'category-header';
          trCategoria.innerHTML = `
            <td>
              <strong>${detalle.categoria}</strong>
              <div class="badge ${detalle.tipo === 'reciclable' ? 'success' : detalle.tipo === 'orgánico' ? 'warning' : 'danger'}" style="margin-left: 8px; font-size: 10px;">
                ${detalle.tipo.toUpperCase()}
              </div>
            </td>
            <td style="text-align:right"><strong>${detalle.total.toFixed(2)}</strong></td>
            <td style="text-align:right"><strong>${porcentajeCategoria}</strong></td>
            <td style="text-align:center">
              <span class="badge ${parseFloat(porcentajeCategoria) > 10 ? 'success' : 'warning'}">
                ${parseFloat(porcentajeCategoria) > 10 ? 'Alta' : 'Media'}
              </span>
            </td>
            <td style="text-align:center">
              <button class="secondary" style="padding: 4px 8px; font-size: 12px;" onclick="toggleSubcategories(this)">
                <i class="fas fa-chevron-down"></i>
              </button>
            </td>
          `;
          tbody.appendChild(trCategoria);
          
          totalGeneral += detalle.total;
          
          // Filas de subcategorías
          detalle.subcategorias.forEach((subcategoria, index) => {
            const porcentajeSubcategoria = currentSummary.totalSum > 0 ? 
              ((subcategoria.valor / currentSummary.totalSum) * 100).toFixed(2) + '%' : '0.00%';
            
            const trSubcategoria = document.createElement('tr');
            trSubcategoria.className = 'subcategory-row';
            trSubcategoria.style.display = showDetails ? '' : 'none';
            trSubcategoria.innerHTML = `
              <td>${subcategoria.nombre}</td>
              <td style="text-align:right">${subcategoria.valor.toFixed(2)}</td>
              <td style="text-align:right">${porcentajeSubcategoria}</td>
              <td style="text-align:center">
                <span class="badge" style="background: ${getCategoryColor(index)}">
                  ${index + 1}
                </span>
              </td>
              <td style="text-align:center">
                <button class="secondary" style="padding: 4px 8px; font-size: 12px;" onclick="alert('Detalles de ${subcategoria.nombre}: ${subcategoria.valor.toFixed(2)} kg (${porcentajeSubcategoria})')">
                  <i class="fas fa-search"></i>
                </button>
              </td>
            `;
            tbody.appendChild(trSubcategoria);
          });
        }
      });
      
      // Agregar fila de total general al final de la tabla
      const totalRow = document.createElement('tr');
      totalRow.className = 'total-row';
      totalRow.innerHTML = `
        <td><strong>TOTAL GENERAL</strong></td>
        <td style="text-align:right"><strong>${totalGeneral.toFixed(2)}</strong></td>
        <td style="text-align:right"><strong>100.00%</strong></td>
        <td style="text-align:center"><strong>N/A</strong></td>
        <td style="text-align:center"></td>
      `;
      tbody.appendChild(totalRow);
    }
    
    // Función para actualizar cambios
    function updateChange(element, value) {
      const isPositive = parseFloat(value) >= 0;
      element.textContent = `${isPositive ? '+' : ''}${value}% vs total`;
      element.className = `summary-change ${isPositive ? 'positive' : 'negative'}`;
      element.innerHTML = `<i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i> <span>${isPositive ? '+' : ''}${value}% vs total</span>`;
    }

    // Acción principal: obtener datos, procesar y renderizar
    async function actualizar() {
      try {
        // Obtener datos del período actual
        currentData = await obtenerFiltrados();
        
        // Procesar datos por categorías
        const currentSummary = calcularResumenPorCategorias(currentData);
        
        // Renderizar gráfico y tabla
        renderChart(currentSummary.categorias, currentSummary.valores, currentChartType);
        renderResumen(currentSummary);
        updateHeaderStats();
        updateSidebarStats(currentSummary);
        updateFilterBadge();
        
        // Actualizar información contextual
        chartInfo.textContent = `Mostrando ${currentData.length} encuestas de ${totalStats.encuestas} totales`;
        summaryBadge.textContent = currentData.length > 0 ? 'Datos actualizados' : 'Sin datos';
        summaryBadge.className = currentData.length > 0 ? 'badge success' : 'badge warning';
        
      } catch (err) {
        console.error(err);
        alert('Error al actualizar. Revisa la consola para más detalles.');
      }
    }

    // Función global para toggle subcategorías
    window.toggleSubcategories = function(button) {
      const row = button.closest('tr');
      const nextRow = row.nextElementSibling;
      const icon = button.querySelector('i');
      
      if (nextRow && nextRow.classList.contains('subcategory-row')) {
        const isHidden = nextRow.style.display === 'none';
        
        // Toggle todas las subcategorías de esta categoría
        let currentRow = nextRow;
        while (currentRow && currentRow.classList.contains('subcategory-row')) {
          currentRow.style.display = isHidden ? '' : 'none';
          currentRow = currentRow.nextElementSibling;
        }
        
        icon.className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
      }
    };

    // Inicialización
    await initApp();

  })();
  </script>
</body>
</html>
