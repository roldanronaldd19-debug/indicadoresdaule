<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Análisis de Desechos Sólidos - Cantón Daule</title>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js con plugins avanzados -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --primary-dark: #0d5d57;
      --secondary: #2d4cc8;
      --accent: #7c3aed;
      --bg1: #f8fafc;
      --bg2: #f0fdfa;
      --card: #ffffff;
      --muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --radius: 12px;
      --header-height: 80px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: #1e293b;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 0 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--header-height);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo i {
      font-size: 32px;
    }
    
    .logo-text {
      display: flex;
      flex-direction: column;
    }
    
    h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
    }
    
    .subtitle {
      opacity: 0.9;
      font-size: 14px;
      margin-top: 2px;
      font-weight: 400;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    main {
      max-width: 1200px;
      margin: 32px auto;
      padding: 0 20px;
    }
    
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .card-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-group label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--muted);
    }
    
    select {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%230f766e'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      appearance: none;
      padding-right: 40px;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    button.secondary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    button.secondary:hover {
      background: var(--bg1);
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    
    .chart-container {
      position: relative;
      height: 500px;
      margin-top: 20px;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    th, td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      font-weight: 600;
      color: var(--muted);
      font-size: 14px;
      background-color: #f8fafc;
    }
    
    tr:hover {
      background-color: #f8fafc;
    }
    
    .statistics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
    }
    
    .stat-card h4 {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .stats-section {
      margin-top: 24px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .stat-item {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
    }
    
    .stat-item:hover {
      transform: translateY(-2px);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .stat-number {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary);
    }
    
    footer {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 24px 0;
      padding: 16px;
      border-top: 1px solid var(--border);
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      flex-direction: column;
      gap: 12px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(15, 118, 110, 0.2);
      border-left: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .export-options {
      display: none;
      position: absolute;
      right: 0;
      top: 40px;
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 8px;
      z-index: 10;
      min-width: 150px;
    }
    
    .export-options.show {
      display: block;
    }
    
    .export-option {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .export-option:hover {
      background: var(--bg1);
    }
    
    .chart-type-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
    }
    
    .chart-type-btn {
      background: white;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .chart-type-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .chart-type-btn:hover:not(.active) {
      background: var(--bg1);
      border-color: var(--primary-light);
    }
    
    .table-total {
      font-weight: bold;
      background-color: #f0f9ff;
    }
    
    .info-text {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .no-data {
      text-align: center;
      color: var(--muted);
      padding: 40px;
      font-style: italic;
    }
    
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 12px;
        height: auto;
        padding: 16px 0;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        justify-content: center;
      }
      
      .chart-container {
        height: 400px;
      }
      
      .chart-type-selector {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-recycle"></i>
        <div class="logo-text">
          <h1>Sistema de Análisis de Desechos Sólidos</h1>
          <div class="subtitle">Cantón Daule - Panel de Control de Gestión de Residuos</div>
        </div>
      </div>
      <div class="header-actions">
        <button id="btnHelp" class="secondary" title="Ayuda">
          <i class="fas fa-question-circle"></i> Ayuda
        </button>
      </div>
    </div>
  </header>

  <main>
    <!-- Panel de control principal -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-sliders-h"></i>
        Configuración de Filtros de Análisis
      </div>
      
      <p class="info-text">
        Utilice los siguientes filtros para segmentar los datos de desechos sólidos según diferentes criterios. 
        Los resultados se actualizarán automáticamente al realizar cambios.
      </p>
      
      <!-- Controles -->
      <div class="controls" id="controls">
        <div class="control-group">
          <label for="selectLugar">Ubicación Geográfica</label>
          <select id="selectLugar">
            <option value="">Todas las ubicaciones</option>
          </select>
        </div>

        <div class="control-group">
          <label for="selectGrupo">Grupo de Estudio</label>
          <select id="selectGrupo">
            <option value="">Todos los grupos</option>
          </select>
        </div>

        <div class="control-group">
          <label for="selectSubgrupo">Subgrupo</label>
          <select id="selectSubgrupo">
            <option value="">Todos los subgrupos</option>
          </select>
        </div>

        <div class="control-group">
          <label for="selectCoordinador">Coordinador</label>
          <select id="selectCoordinador">
            <option value="">Todos los coordinadores</option>
          </select>
        </div>
      </div>

      <div class="action-buttons">
        <div style="position: relative;">
          <button id="btnExport" class="secondary">
            <i class="fas fa-download"></i> Exportar Datos
          </button>
          <div class="export-options" id="exportOptions">
            <div class="export-option" data-type="png">
              <i class="fas fa-image"></i> Gráfico (PNG)
            </div>
            <div class="export-option" data-type="csv">
              <i class="fas fa-file-csv"></i> Datos (CSV)
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos y visualizaciones -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-chart-bar"></i>
        Visualización de Datos de Desechos Sólidos
      </div>
      
      <p class="info-text">
        Explore diferentes visualizaciones de los datos de desechos sólidos. 
        Seleccione entre las pestañas para ver diferentes tipos de análisis y comparaciones.
      </p>
      
      <div class="tabs">
        <div class="tab active" data-tab="main-chart">Distribución por Categoría</div>
        <div class="tab" data-tab="comparison">Comparación por Grupos</div>
      </div>
      
      <div class="tab-content active" id="main-chart">
        <!-- Selector de tipo de gráfico -->
        <div class="chart-type-selector">
          <span style="font-size: 14px; color: var(--muted); margin-right: 8px;">Tipo de gráfico:</span>
          <div class="chart-type-btn active" data-type="bar">
            <i class="fas fa-chart-bar"></i> Barras
          </div>
          <div class="chart-type-btn" data-type="pie">
            <i class="fas fa-chart-pie"></i> Circular
          </div>
          <div class="chart-type-btn" data-type="line">
            <i class="fas fa-chart-line"></i> Líneas
          </div>
          <div class="chart-type-btn" data-type="radar">
            <i class="fas fa-bullseye"></i> Radar
          </div>
          <div class="chart-type-btn" data-type="histogram">
            <i class="fas fa-chart-bar"></i> Histograma
          </div>
          <div class="chart-type-btn" data-type="scatter">
            <i class="fas fa-braille"></i> Dispersión
          </div>
        </div>
        
        <div class="chart-container">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
      
      <div class="tab-content" id="comparison">
        <p class="info-text">
          Esta visualización compara la distribución de desechos entre diferentes grupos de estudio, 
          permitiendo identificar patrones y diferencias significativas.
        </p>
        <div class="chart-container">
          <canvas id="comparisonChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Estadísticas básicas completas -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-chart-pie"></i>
        Estadísticas Descriptivas de los Desechos Sólidos
      </div>
      
      <p class="info-text">
        Resumen estadístico completo de los datos de desechos sólidos, incluyendo métricas básicas y avanzadas 
        para comprender la distribución y características de los residuos.
      </p>
      
      <div class="stats-section">
        <h3 style="color: var(--primary); margin-bottom: 16px;">Resumen del Conjunto de Datos</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">Total de Registros</div>
            <div class="stat-number" id="statTotalRecords">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Ubicaciones Únicas</div>
            <div class="stat-number" id="statUniquePlaces">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Grupos de Estudio</div>
            <div class="stat-number" id="statUniqueGroups">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Coordinadores</div>
            <div class="stat-number" id="statUniqueCoordinators">0</div>
          </div>
        </div>
      </div>
      
      <div class="stats-section">
        <h3 style="color: var(--primary); margin-bottom: 16px;">Distribución de Desechos</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">Categoría con Mayor Cantidad</div>
            <div class="stat-number" id="statMaxCategory">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Categoría con Menor Cantidad</div>
            <div class="stat-number" id="statMinCategory">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Promedio por Categoría (kg)</div>
            <div class="stat-number" id="statAvgPerCategory">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Mediana por Categoría (kg)</div>
            <div class="stat-number" id="statMedianPerCategory">0</div>
          </div>
        </div>
      </div>
      
      <div class="stats-section">
        <h3 style="color: var(--primary); margin-bottom: 16px;">Estadísticas Avanzadas</h3>
        <div class="statistics-grid">
          <div class="stat-card">
            <h4>Desviación Estándar</h4>
            <div class="stat-value" id="statStdDev">0</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
              Mide la variabilidad de los datos
            </div>
          </div>
          
          <div class="stat-card">
            <h4>Coeficiente de Variación</h4>
            <div class="stat-value" id="statCV">0%</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
              Dispersión relativa de los datos
            </div>
          </div>
          
          <div class="stat-card">
            <h4>Índice de Gini</h4>
            <div class="stat-value" id="statGini">0</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
              Desigualdad en la distribución
            </div>
          </div>
          
          <div class="stat-card">
            <h4>Total General (kg)</h4>
            <div class="stat-value" id="statTotalKg">0</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
              Suma de todos los desechos registrados
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla resumen -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-table"></i>
        Tabla Resumen Detallada de Desechos por Categoría
      </div>
      
      <p class="info-text">
        Desglose detallado de los desechos sólidos por categoría, mostrando el peso en kilogramos 
        y el porcentaje que representa cada categoría respecto al total.
      </p>
      
      <div class="table-responsive">
        <table id="tableResumen">
          <thead>
            <tr>
              <th>Tipo de Desecho</th>
              <th style="text-align:right">Peso (kg)</th>
              <th style="text-align:right">% del Total</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr class="table-total">
              <td><strong>Total General</strong></td>
              <td style="text-align:right"><strong id="tableTotalKg">0</strong></td>
              <td style="text-align:right"><strong>100%</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <footer>
      <p>Sistema de Análisis de Desechos Sólidos - Cantón Daule | Fuente: Base de datos <code>caracterizacion_desechos_daule</code> | Última actualización: 25 de noviembre de 2025</p>
    </footer>
  </main>

  <script>
  (async function(){
    // ---------- CONFIGURACIÓN ----------
    const SUPABASE_URL = "https://dutapywxsiuxboqsjqvf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ---------- SELECTORES ----------
    const selectLugar = document.getElementById('selectLugar');
    const selectGrupo = document.getElementById('selectGrupo');
    const selectSubgrupo = document.getElementById('selectSubgrupo');
    const selectCoordinador = document.getElementById('selectCoordinador');
    const btnExport = document.getElementById('btnExport');
    const exportOptions = document.getElementById('exportOptions');
    const tableTotalKg = document.getElementById('tableTotalKg');

    // Elementos de estadísticas básicas
    const statTotalRecords = document.getElementById('statTotalRecords');
    const statUniquePlaces = document.getElementById('statUniquePlaces');
    const statUniqueGroups = document.getElementById('statUniqueGroups');
    const statUniqueCoordinators = document.getElementById('statUniqueCoordinators');
    const statMaxCategory = document.getElementById('statMaxCategory');
    const statMinCategory = document.getElementById('statMinCategory');
    const statAvgPerCategory = document.getElementById('statAvgPerCategory');
    const statMedianPerCategory = document.getElementById('statMedianPerCategory');
    
    // Elementos de estadísticas avanzadas
    const statStdDev = document.getElementById('statStdDev');
    const statCV = document.getElementById('statCV');
    const statGini = document.getElementById('statGini');
    const statTotalKg = document.getElementById('statTotalKg');

    // Tabla
    const tbody = document.querySelector('#tableResumen tbody');

    // Charts
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    let mainChart, comparisonChart;

    // Variables globales para datos
    let currentData = [];
    let allData = [];
    let currentChartType = 'bar';

    // Inicializar la aplicación
    async function initApp() {
      await cargarTodosLosDatos();
      await inicializarFiltros();
      await actualizar();
      setupEventListeners();
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Actualización automática al cambiar filtros
      selectLugar.addEventListener('change', async function() {
        await actualizarFiltrosDependientes();
        await actualizar();
      });
      
      selectGrupo.addEventListener('change', async function() {
        await actualizarFiltrosDependientes();
        await actualizar();
      });
      
      selectSubgrupo.addEventListener('change', async function() {
        await actualizarFiltrosDependientes();
        await actualizar();
      });
      
      selectCoordinador.addEventListener('change', actualizar);
      
      // Selector de tipo de gráfico principal
      document.querySelectorAll('#main-chart .chart-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Remover clase activa de todos los botones
          document.querySelectorAll('#main-chart .chart-type-btn').forEach(b => b.classList.remove('active'));
          // Agregar clase activa al botón clickeado
          this.classList.add('active');
          // Actualizar tipo de gráfico
          currentChartType = this.getAttribute('data-type');
          // Re-renderizar el gráfico
          if (currentData.length > 0) {
            const currentSummary = resumenPorCategorias(currentData);
            renderChart(currentSummary.labels, currentSummary.values, currentChartType);
          }
        });
      });
      
      // Toggle export options
      btnExport.addEventListener('click', (e) => {
        e.stopPropagation();
        exportOptions.classList.toggle('show');
      });
      
      // Cerrar export options al hacer clic fuera
      document.addEventListener('click', () => {
        exportOptions.classList.remove('show');
      });
      
      // Manejar opciones de exportación
      document.querySelectorAll('.export-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const type = e.currentTarget.getAttribute('data-type');
          exportarDatos(type);
          exportOptions.classList.remove('show');
        });
      });
      
      // Manejar pestañas
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          
          // Actualizar pestañas activas
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(tabId).classList.add('active');
          
          // Renderizar gráficos específicos si es necesario
          if (tabId === 'comparison') {
            renderComparison();
          }
        });
      });
      
      // Ayuda
      document.getElementById('btnHelp').addEventListener('click', () => {
        alert('Este panel permite analizar datos de desechos sólidos del Cantón Daule. Utilice los filtros para segmentar los datos según diferentes criterios. Explore las diferentes visualizaciones disponibles para obtener insights sobre la distribución y características de los desechos sólidos en la región.');
      });
    }

    // Cargar todos los datos para análisis
    async function cargarTodosLosDatos() {
      try {
        const q = await supabase.from('caracterizacion_desechos_daule').select('*');
        if (q.error) {
          console.error(q.error);
          alert('Error al cargar los datos: ' + q.error.message);
          return;
        }
        allData = q.data || [];
      } catch (error) {
        console.error('Error al cargar datos:', error);
        alert('Error al cargar los datos. Verifique su conexión a internet.');
      }
    }

    // Inicializar filtros con todos los datos disponibles
    async function inicializarFiltros() {
      // Limpiar selects
      selectLugar.innerHTML = '<option value="">Todas las ubicaciones</option>';
      selectGrupo.innerHTML = '<option value="">Todos los grupos</option>';
      selectSubgrupo.innerHTML = '<option value="">Todos los subgrupos</option>';
      selectCoordinador.innerHTML = '<option value="">Todos los coordinadores</option>';

      // Obtener valores únicos de todos los datos
      const lugares = [...new Set(allData.map(r => r.lugar).filter(Boolean))].sort();
      const grupos = [...new Set(allData.map(r => r.grupo).filter(Boolean))].sort();
      const subgrupos = [...new Set(allData.map(r => r.subgrupo).filter(Boolean))].sort();
      const coordinadores = [...new Set(allData.map(r => r.coordinador).filter(Boolean))].sort();

      // Llenar selects
      lugares.forEach(v => selectLugar.appendChild(Object.assign(document.createElement('option'), { value: v, textContent: v })));
      grupos.forEach(v => selectGrupo.appendChild(Object.assign(document.createElement('option'), { value: v, textContent: v })));
      subgrupos.forEach(v => selectSubgrupo.appendChild(Object.assign(document.createElement('option'), { value: v, textContent: v })));
      coordinadores.forEach(v => selectCoordinador.appendChild(Object.assign(document.createElement('option'), { value: v, textContent: v })));
    }

    // Actualizar filtros dependientes según selección actual
    async function actualizarFiltrosDependientes() {
      // Obtener datos filtrados según selecciones actuales
      let filteredData = [...allData];
      
      if (selectLugar.value) {
        filteredData = filteredData.filter(item => item.lugar === selectLugar.value);
      }
      
      if (selectGrupo.value) {
        filteredData = filteredData.filter(item => item.grupo === selectGrupo.value);
      }
      
      if (selectSubgrupo.value) {
        filteredData = filteredData.filter(item => item.subgrupo === selectSubgrupo.value);
      }

      // Guardar valores seleccionados actuales
      const selectedGrupo = selectGrupo.value;
      const selectedSubgrupo = selectSubgrupo.value;
      const selectedCoordinador = selectCoordinador.value;

      // Actualizar select de Grupo
      const gruposDisponibles = [...new Set(filteredData.map(r => r.grupo).filter(Boolean))].sort();
      selectGrupo.innerHTML = '<option value="">Todos los grupos</option>';
      gruposDisponibles.forEach(v => {
        const option = Object.assign(document.createElement('option'), { 
          value: v, 
          textContent: v
        });
        if (v === selectedGrupo && gruposDisponibles.includes(selectedGrupo)) {
          option.selected = true;
        }
        selectGrupo.appendChild(option);
      });

      // Actualizar select de Subgrupo
      const subgruposDisponibles = [...new Set(filteredData.map(r => r.subgrupo).filter(Boolean))].sort();
      selectSubgrupo.innerHTML = '<option value="">Todos los subgrupos</option>';
      subgruposDisponibles.forEach(v => {
        const option = Object.assign(document.createElement('option'), { 
          value: v, 
          textContent: v
        });
        if (v === selectedSubgrupo && subgruposDisponibles.includes(selectedSubgrupo)) {
          option.selected = true;
        }
        selectSubgrupo.appendChild(option);
      });

      // Actualizar select de Coordinador
      const coordinadoresDisponibles = [...new Set(filteredData.map(r => r.coordinador).filter(Boolean))].sort();
      selectCoordinador.innerHTML = '<option value="">Todos los coordinadores</option>';
      coordinadoresDisponibles.forEach(v => {
        const option = Object.assign(document.createElement('option'), { 
          value: v, 
          textContent: v
        });
        if (v === selectedCoordinador && coordinadoresDisponibles.includes(selectedCoordinador)) {
          option.selected = true;
        }
        selectCoordinador.appendChild(option);
      });
    }

    // Construir query según filtros y traer datos
    async function obtenerFiltrados() {
      let filteredData = [...allData];
      
      if (selectLugar.value) {
        filteredData = filteredData.filter(item => item.lugar === selectLugar.value);
      }
      
      if (selectGrupo.value) {
        filteredData = filteredData.filter(item => item.grupo === selectGrupo.value);
      }
      
      if (selectSubgrupo.value) {
        filteredData = filteredData.filter(item => item.subgrupo === selectSubgrupo.value);
      }
      
      if (selectCoordinador.value) {
        filteredData = filteredData.filter(item => item.coordinador === selectCoordinador.value);
      }
      
      return filteredData;
    }

    // Procesa filas y calcula totales por columna *_kg
    function resumenPorCategorias(rows) {
      if (!rows || rows.length === 0) return { labels: [], values: [], totalesObj: {}, totalSum: 0 };
      
      const totales = {};
      
      rows.forEach(row => {
        Object.entries(row).forEach(([k, v]) => {
          if (k.endsWith('_kg')) {
            const val = parseFloat(v) || 0;
            totales[k] = (totales[k] || 0) + val;
          }
        });
      });
      
      const labels = Object.keys(totales).sort();
      const values = labels.map(l => totales[l]);
      const totalSum = values.reduce((a, b) => a + b, 0);
      
      return { labels, values, totalesObj: totales, totalSum };
    }

    // Calcular estadísticas básicas completas
    function calcularEstadisticasBasicas(rows, currentSummary) {
      if (rows.length === 0) return {
        totalRecords: 0,
        uniquePlaces: 0,
        uniqueGroups: 0,
        uniqueCoordinators: 0,
        maxCategory: '-',
        minCategory: '-',
        avgPerCategory: 0,
        medianPerCategory: 0
      };
      
      // Estadísticas generales
      const totalRecords = rows.length;
      
      // Lugares, grupos y coordinadores únicos
      const lugaresUnicos = [...new Set(rows.map(r => r.lugar).filter(Boolean))];
      const gruposUnicos = [...new Set(rows.map(r => r.grupo).filter(Boolean))];
      const coordinadoresUnicos = [...new Set(rows.map(r => r.coordinador).filter(Boolean))];
      
      // Estadísticas de categorías
      let maxCategory = '-', minCategory = '-';
      let avgPerCategory = 0, medianPerCategory = 0;
      
      if (currentSummary.values.length > 0) {
        const maxIndex = currentSummary.values.indexOf(Math.max(...currentSummary.values));
        const minIndex = currentSummary.values.indexOf(Math.min(...currentSummary.values.filter(v => v > 0)));
        
        maxCategory = currentSummary.labels[maxIndex] ? currentSummary.labels[maxIndex].replace(/_/g, ' ').replace('kg', '').toUpperCase() : '-';
        minCategory = currentSummary.labels[minIndex] ? currentSummary.labels[minIndex].replace(/_/g, ' ').replace('kg', '').toUpperCase() : '-';
        
        avgPerCategory = currentSummary.totalSum / currentSummary.values.length;
        
        // Calcular mediana
        const sortedValues = [...currentSummary.values].sort((a, b) => a - b);
        const mid = Math.floor(sortedValues.length / 2);
        medianPerCategory = sortedValues.length % 2 !== 0 ? 
          sortedValues[mid] : 
          (sortedValues[mid - 1] + sortedValues[mid]) / 2;
      }
      
      return {
        totalRecords,
        uniquePlaces: lugaresUnicos.length,
        uniqueGroups: gruposUnicos.length,
        uniqueCoordinators: coordinadoresUnicos.length,
        maxCategory,
        minCategory,
        avgPerCategory,
        medianPerCategory
      };
    }

    // Calcular estadísticas avanzadas
    function calcularEstadisticasAvanzadas(values, totalSum) {
      if (values.length === 0) return { stdDev: 0, cv: 0, gini: 0, totalSum: 0 };
      
      // Desviación estándar
      const mean = totalSum / values.length;
      const squaredDiffs = values.map(value => Math.pow(value - mean, 2));
      const avgSquaredDiff = squaredDiffs.reduce((sum, value) => sum + value, 0) / values.length;
      const stdDev = Math.sqrt(avgSquaredDiff);
      
      // Coeficiente de variación
      const cv = totalSum > 0 ? (stdDev / mean) * 100 : 0;
      
      // Índice de Gini (simplificado para este contexto)
      const sortedValues = [...values].sort((a, b) => a - b);
      const n = sortedValues.length;
      let giniSum = 0;
      
      for (let i = 0; i < n; i++) {
        giniSum += (i + 1) * sortedValues[i];
      }
      
      const gini = totalSum > 0 ? (2 * giniSum) / (n * totalSum) - (n + 1) / n : 0;
      
      return { stdDev, cv, gini, totalSum };
    }

    // Renderizar gráfico principal con tipo seleccionado
    function renderChart(labels, values, chartType) {
      const friendlyLabels = labels.map(l => {
        // Mejorar nombres de categorías basados en el documento
        const nameMap = {
          'de_jardin_kg': 'Desechos de Jardín',
          'de_cocina_kg': 'Desechos de Cocina',
          'aceite_comestible_kg': 'Aceite Comestible',
          'papel_blanco_kg': 'Papel Blanco',
          'papel_periodico_kg': 'Papel Periódico',
          'papel_archivo_kg': 'Papel de Archivo',
          'carton_kg': 'Cartón',
          'tetra_brik_kg': 'Tetra Brik',
          'pet_kg': 'PET',
          'plastico_mixto_kg': 'Plástico Mixto',
          'bot_aceite_kg': 'Botellas de Aceite',
          'bolsas_kg': 'Bolsas Plásticas',
          'vidrio_blanco_kg': 'Vidrio Blanco',
          'vidrio_verde_kg': 'Vidrio Verde',
          'vidrio_otros_kg': 'Otros Vidrios',
          'latas_ferrosas_kg': 'Latas Ferrosas',
          'aluminio_kg': 'Aluminio',
          'acero_kg': 'Acero',
          'metal_otros_kg': 'Otros Metales',
          'ropa_kg': 'Ropa y Textiles',
          'zapatos_neumaticos_kg': 'Zapatos y Neumáticos',
          'papel_higienico_kg': 'Papel Higiénico',
          'maderas_kg': 'Maderas',
          'electronicos_kg': 'Electrónicos'
        };
        
        return nameMap[l] || l.replace(/_/g, ' ').replace('kg', '').replace(/\b\w/g, l => l.toUpperCase());
      });
      
      // Colores consistentes (HSL)
      const colors = friendlyLabels.map((_, i) => `hsl(${(i * 360 / friendlyLabels.length) % 360} 70% 55%)`);
      
      if (mainChart) mainChart.destroy();
      
      // Si no hay datos, mostrar mensaje
      if (values.length === 0 || values.every(v => v === 0)) {
        mainCtx.clearRect(0, 0, mainCtx.canvas.width, mainCtx.canvas.height);
        mainCtx.font = '16px Inter';
        mainCtx.fillStyle = '#64748b';
        mainCtx.textAlign = 'center';
        mainCtx.fillText('No hay datos disponibles para mostrar', mainCtx.canvas.width / 2, mainCtx.canvas.height / 2);
        return;
      }
      
      // Configuración base para todos los gráficos
      const baseConfig = {
        data: {
          labels: friendlyLabels,
          datasets: [{
            label: 'Peso (kg)',
            data: values,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('hsl', 'hsla').replace(')', ', 0.8)')),
            borderWidth: chartType === 'line' ? 2 : 1,
            pointBackgroundColor: colors,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: chartType === 'pie' ? 'right' : 'top',
              labels: {
                font: {
                  size: 12
                }
              }
            },
            title: {
              display: true,
              text: `Distribución de Desechos Sólidos por Categoría - ${getChartTypeName(chartType)}`,
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: 20
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) label += ': ';
                  label += context.parsed !== undefined ? context.parsed.toFixed(2) + ' kg' : context.raw.toFixed(2) + ' kg';
                  return label;
                }
              }
            }
          }
        }
      };
      
      // Configuraciones específicas por tipo de gráfico
      const typeSpecificConfigs = {
        bar: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Peso (kg)',
                font: { size: 14, weight: 'bold' }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Categorías de Desechos',
                font: { size: 14, weight: 'bold' }
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        },
        line: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Peso (kg)',
                font: { size: 14, weight: 'bold' }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Categorías de Desechos',
                font: { size: 14, weight: 'bold' }
              }
            }
          }
        },
        pie: {
          // Configuración específica para gráfico circular
          plugins: {
            datalabels: {
              formatter: (value, ctx) => {
                let sum = 0;
                let dataArr = ctx.chart.data.datasets[0].data;
                dataArr.map(data => {
                  sum += data;
                });
                let percentage = (value*100 / sum).toFixed(2)+"%";
                return percentage;
              },
              color: '#fff',
              font: {
                weight: 'bold',
                size: 12
              }
            }
          }
        },
        radar: {
          scales: {
            r: {
              beginAtZero: true,
              ticks: {
                display: false
              }
            }
          }
        }
      };
      
      // Para histograma y scatter, necesitamos transformar los datos
      if (chartType === 'histogram') {
        // Calcular bins para el histograma
        const maxValue = Math.max(...values);
        const minValue = Math.min(...values);
        const binCount = Math.min(10, values.length);
        const binWidth = (maxValue - minValue) / binCount;
        
        const bins = Array(binCount).fill(0);
        values.forEach(value => {
          const binIndex = Math.min(Math.floor((value - minValue) / binWidth), binCount - 1);
          bins[binIndex]++;
        });
        
        const binLabels = Array(binCount).fill(0).map((_, i) => {
          const start = minValue + i * binWidth;
          const end = minValue + (i + 1) * binWidth;
          return `${start.toFixed(1)} - ${end.toFixed(1)}`;
        });
        
        baseConfig.data.labels = binLabels;
        baseConfig.data.datasets[0].data = bins;
        baseConfig.data.datasets[0].label = 'Frecuencia';
        baseConfig.data.datasets[0].backgroundColor = 'rgba(15, 118, 110, 0.7)';
        baseConfig.data.datasets[0].borderColor = 'rgba(15, 118, 110, 1)';
        
        // Configuración específica para histograma
        typeSpecificConfigs.histogram = {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Frecuencia',
                font: { size: 14, weight: 'bold' }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Rango de Pesos (kg)',
                font: { size: 14, weight: 'bold' }
              }
            }
          }
        };
        
      } else if (chartType === 'scatter') {
        // Gráfico de dispersión
        const dataPoints = values.map((value, index) => ({
          x: index,
          y: value
        }));
        
        baseConfig.data.labels = undefined;
        baseConfig.data.datasets[0].data = dataPoints;
        baseConfig.data.datasets[0].label = 'Datos';
        baseConfig.data.datasets[0].backgroundColor = 'rgba(15, 118, 110, 0.7)';
        baseConfig.data.datasets[0].borderColor = 'rgba(15, 118, 110, 1)';
        
        // Calcular línea de regresión lineal simple
        const n = dataPoints.length;
        const sumX = dataPoints.reduce((sum, point) => sum + point.x, 0);
        const sumY = dataPoints.reduce((sum, point) => sum + point.y, 0);
        const sumXY = dataPoints.reduce((sum, point) => sum + point.x * point.y, 0);
        const sumXX = dataPoints.reduce((sum, point) => sum + point.x * point.x, 0);
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        const regressionLine = dataPoints.map(point => ({
          x: point.x,
          y: slope * point.x + intercept
        }));
        
        // Agregar línea de regresión como segundo dataset
        baseConfig.data.datasets.push({
          label: 'Línea de Regresión',
          data: regressionLine,
          type: 'line',
          borderColor: 'rgba(239, 68, 68, 0.8)',
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
          tension: 0
        });
        
        // Configuración específica para scatter
        typeSpecificConfigs.scatter = {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Peso (kg)',
                font: { size: 14, weight: 'bold' }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Índice de Categoría',
                font: { size: 14, weight: 'bold' }
              }
            }
          }
        };
      }
      
      // Combinar configuración base con configuración específica del tipo
      const finalConfig = {
        type: chartType === 'scatter' ? 'scatter' : chartType,
        data: baseConfig.data,
        options: {
          ...baseConfig.options,
          ...(typeSpecificConfigs[chartType] || {})
        }
      };
      
      mainChart = new Chart(mainCtx, finalConfig);
    }
    
    // Obtener nombre legible del tipo de gráfico
    function getChartTypeName(type) {
      const names = {
        'bar': 'Gráfico de Barras',
        'pie': 'Gráfico Circular',
        'line': 'Gráfico de Líneas',
        'radar': 'Gráfico Radar',
        'histogram': 'Histograma',
        'scatter': 'Gráfico de Dispersión'
      };
      return names[type] || type;
    }

    // Renderizar comparación
    function renderComparison() {
      if (!currentData.length) {
        comparisonCtx.clearRect(0, 0, comparisonCtx.canvas.width, comparisonCtx.canvas.height);
        comparisonCtx.font = '16px Inter';
        comparisonCtx.fillStyle = '#64748b';
        comparisonCtx.textAlign = 'center';
        comparisonCtx.fillText('No hay datos disponibles para mostrar', comparisonCtx.canvas.width / 2, comparisonCtx.canvas.height / 2);
        return;
      }
      
      // Agrupar datos por grupo
      const datosPorGrupo = {};
      currentData.forEach(row => {
        const grupo = row.grupo || 'Sin Grupo';
        if (!datosPorGrupo[grupo]) datosPorGrupo[grupo] = {};
        
        Object.entries(row).forEach(([k, v]) => {
          if (k.endsWith('_kg')) {
            const val = parseFloat(v) || 0;
            datosPorGrupo[grupo][k] = (datosPorGrupo[grupo][k] || 0) + val;
          }
        });
      });
      
      // Obtener categorías únicas
      const categorias = [...new Set(
        Object.values(datosPorGrupo).flatMap(obj => Object.keys(obj))
      )].sort();
      
      const grupos = Object.keys(datosPorGrupo);
      
      // Colores para los grupos
      const coloresGrupos = grupos.map((_, i) => 
        `hsl(${(i * 360 / grupos.length) % 360} 70% 55%)`
      );
      
      const datasets = grupos.map((grupo, i) => {
        return {
          label: grupo,
          data: categorias.map(cat => datosPorGrupo[grupo][cat] || 0),
          backgroundColor: coloresGrupos[i],
          borderColor: coloresGrupos[i].replace('hsl', 'hsla').replace(')', ', 0.8)'),
          borderWidth: 1
        };
      });
      
      const friendlyLabels = categorias.map(l => {
        const nameMap = {
          'de_jardin_kg': 'Jardín',
          'de_cocina_kg': 'Cocina',
          'aceite_comestible_kg': 'Aceite',
          'papel_blanco_kg': 'Papel Blanco',
          'papel_periodico_kg': 'Periódico',
          'papel_archivo_kg': 'Papel Archivo',
          'carton_kg': 'Cartón',
          'tetra_brik_kg': 'Tetra Brik',
          'pet_kg': 'PET',
          'plastico_mixto_kg': 'Plástico Mixto'
        };
        
        return nameMap[l] || l.replace(/_/g, ' ').replace('kg', '').replace(/\b\w/g, l => l.toUpperCase());
      });
      
      if (comparisonChart) comparisonChart.destroy();
      
      comparisonChart = new Chart(comparisonCtx, {
        type: 'bar',
        data: {
          labels: friendlyLabels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  size: 12
                }
              }
            },
            title: {
              display: true,
              text: 'Comparación de Desechos por Grupo de Estudio',
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: 20
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Peso (kg)',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Categorías de Desechos',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              }
            }
          }
        }
      });
    }

    // Rellenar tabla resumen y estadísticas
    function renderResumen(currentSummary, basicStats, advancedStats) {
      tbody.innerHTML = '';
      
      if (currentSummary.labels.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td colspan="3" class="no-data">No hay datos disponibles para mostrar</td>
        `;
        tbody.appendChild(tr);
        return;
      }
      
      const friendlyLabels = currentSummary.labels.map(l => {
        const nameMap = {
          'de_jardin_kg': 'Desechos de Jardín',
          'de_cocina_kg': 'Desechos de Cocina',
          'aceite_comestible_kg': 'Aceite Comestible',
          'papel_blanco_kg': 'Papel Blanco',
          'papel_periodico_kg': 'Papel Periódico',
          'papel_archivo_kg': 'Papel de Archivo',
          'carton_kg': 'Cartón',
          'tetra_brik_kg': 'Tetra Brik',
          'pet_kg': 'PET',
          'plastico_mixto_kg': 'Plástico Mixto',
          'bot_aceite_kg': 'Botellas de Aceite',
          'bolsas_kg': 'Bolsas Plásticas',
          'vidrio_blanco_kg': 'Vidrio Blanco',
          'vidrio_verde_kg': 'Vidrio Verde',
          'vidrio_otros_kg': 'Otros Vidrios',
          'latas_ferrosas_kg': 'Latas Ferrosas',
          'aluminio_kg': 'Aluminio',
          'acero_kg': 'Acero',
          'metal_otros_kg': 'Otros Metales',
          'ropa_kg': 'Ropa y Textiles',
          'zapatos_neumaticos_kg': 'Zapatos y Neumáticos',
          'papel_higienico_kg': 'Papel Higiénico',
          'maderas_kg': 'Maderas',
          'electronicos_kg': 'Electrónicos'
        };
        
        return nameMap[l] || l.replace(/_/g, ' ').replace('kg', '').replace(/\b\w/g, l => l.toUpperCase());
      });
      
      // Actualizar estadísticas básicas
      statTotalRecords.textContent = basicStats.totalRecords;
      statUniquePlaces.textContent = basicStats.uniquePlaces;
      statUniqueGroups.textContent = basicStats.uniqueGroups;
      statUniqueCoordinators.textContent = basicStats.uniqueCoordinators;
      statMaxCategory.textContent = basicStats.maxCategory;
      statMinCategory.textContent = basicStats.minCategory;
      statAvgPerCategory.textContent = basicStats.avgPerCategory.toFixed(2);
      statMedianPerCategory.textContent = basicStats.medianPerCategory.toFixed(2);
      
      // Actualizar estadísticas avanzadas
      statStdDev.textContent = advancedStats.stdDev.toFixed(2);
      statCV.textContent = advancedStats.cv.toFixed(2) + '%';
      statGini.textContent = advancedStats.gini.toFixed(3);
      statTotalKg.textContent = advancedStats.totalSum.toFixed(2);
      
      // Actualizar total en la tabla
      tableTotalKg.textContent = advancedStats.totalSum.toFixed(2);
      
      // Llenar tabla
      friendlyLabels.forEach((lab, i) => {
        const v = currentSummary.values[i];
        if (v <= 0) return;
        
        const pct = currentSummary.totalSum > 0 ? ((v / currentSummary.totalSum) * 100).toFixed(2) + '%' : '0.00%';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${lab}</td>
          <td style="text-align:right">${v.toFixed(2)}</td>
          <td style="text-align:right">${pct}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Exportar datos
    function exportarDatos(tipo) {
      if (!currentData.length) {
        alert('No hay datos para exportar');
        return;
      }
      
      switch (tipo) {
        case 'png':
          const activeTab = document.querySelector('.tab-content.active').id;
          let chartToExport;
          
          if (activeTab === 'main-chart') chartToExport = mainChart;
          else if (activeTab === 'comparison') chartToExport = comparisonChart;
          
          if (!chartToExport) {
            alert('Gráfico no disponible');
            return;
          }
          
          const a = document.createElement('a');
          a.href = chartToExport.toBase64Image();
          a.download = 'grafico-desechos-daule.png';
          document.body.appendChild(a);
          a.click();
          a.remove();
          break;
          
        case 'csv':
          const currentSummary = resumenPorCategorias(currentData);
          const friendlyLabels = currentSummary.labels.map(l => {
            const nameMap = {
              'de_jardin_kg': 'Desechos de Jardín',
              'de_cocina_kg': 'Desechos de Cocina',
              'aceite_comestible_kg': 'Aceite Comestible',
              'papel_blanco_kg': 'Papel Blanco',
              'papel_periodico_kg': 'Papel Periódico',
              'papel_archivo_kg': 'Papel de Archivo',
              'carton_kg': 'Cartón',
              'tetra_brik_kg': 'Tetra Brik',
              'pet_kg': 'PET',
              'plastico_mixto_kg': 'Plástico Mixto',
              'bot_aceite_kg': 'Botellas de Aceite',
              'bolsas_kg': 'Bolsas Plásticas',
              'vidrio_blanco_kg': 'Vidrio Blanco',
              'vidrio_verde_kg': 'Vidrio Verde',
              'vidrio_otros_kg': 'Otros Vidrios',
              'latas_ferrosas_kg': 'Latas Ferrosas',
              'aluminio_kg': 'Aluminio',
              'acero_kg': 'Acero',
              'metal_otros_kg': 'Otros Metales',
              'ropa_kg': 'Ropa y Textiles',
              'zapatos_neumaticos_kg': 'Zapatos y Neumáticos',
              'papel_higienico_kg': 'Papel Higiénico',
              'maderas_kg': 'Maderas',
              'electronicos_kg': 'Electrónicos'
            };
            
            return nameMap[l] || l.replace(/_/g, ' ').replace('kg', '').replace(/\b\w/g, l => l.toUpperCase());
          });
          
          let csvContent = "Categoría de Desecho,Peso (kg),Porcentaje del Total\n";
          friendlyLabels.forEach((lab, i) => {
            const v = currentSummary.values[i];
            if (v <= 0) return;
            const pct = currentSummary.totalSum > 0 ? ((v / currentSummary.totalSum) * 100).toFixed(2) : '0.00';
            csvContent += `"${lab}",${v.toFixed(2)},${pct}%\n`;
          });
          
          // Agregar total al CSV
          csvContent += `"TOTAL GENERAL",${currentSummary.totalSum.toFixed(2)},100.00%\n`;
          
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.setAttribute('href', url);
          link.setAttribute('download', 'datos-desechos-daule.csv');
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          break;
      }
    }

    // Acción principal: obtener datos, procesar y renderizar
    async function actualizar() {
      try {
        // Obtener datos del período actual
        currentData = await obtenerFiltrados();
        
        // Procesar datos
        const currentSummary = resumenPorCategorias(currentData);
        
        // Calcular estadísticas
        const basicStats = calcularEstadisticasBasicas(currentData, currentSummary);
        const advancedStats = calcularEstadisticasAvanzadas(currentSummary.values, currentSummary.totalSum);
        
        // Renderizar
        renderChart(currentSummary.labels, currentSummary.values, currentChartType);
        renderResumen(currentSummary, basicStats, advancedStats);
        
        // Si la pestaña de comparación está activa, renderizarla
        if (document.querySelector('.tab[data-tab="comparison"]').classList.contains('active')) {
          renderComparison();
        }
      } catch (err) {
        console.error(err);
        alert('Error al actualizar. Revisa la consola para más detalles.');
      }
    }

    // Inicialización
    await initApp();

  })();
  </script>
</body>
</html>
